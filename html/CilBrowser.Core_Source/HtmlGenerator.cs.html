<html><head><title>Source file: HtmlGenerator.cs</title><style>.memberid { color: rgb(43, 145, 175); text-decoration: none; }</style></head>
<body><p>.NET CIL Browser&nbsp;-&nbsp;<a href="index.html">Back to table of contents</a></p>
<h2>Source file: HtmlGenerator.cs</h2><table width="100%" cellpadding="5" cellspacing="5"><tr><td width="200" valign="top" style="border: thin solid;"><p>Files in CilBrowser.Core directory:</p><p><a href="AssemblyServer.cs.html">AssemblyServer.cs</a></p><p><a href="CilBrowser.Core.csproj.html">CilBrowser.Core.csproj</a></p><p><a href="CilBrowserOptions.cs.html">CilBrowserOptions.cs</a></p><p><a href="FileUtils.cs.html">FileUtils.cs</a></p><p><a href="HtmlAttribute.cs.html">HtmlAttribute.cs</a></p><p><a href="HtmlBuilder.cs.html">HtmlBuilder.cs</a></p><p><b>HtmlGenerator.cs</b></p><p><a href="ServerBase.cs.html">ServerBase.cs</a></p><p><a href="SourceServer.cs.html">SourceServer.cs</a></p><p><a href="Utils.cs.html">Utils.cs</a></p><p><a href="WebsiteGenerator.cs.html">WebsiteGenerator.cs</a></p></td>
<td valign="top"><pre style="white-space: pre-wrap;"><code><span style="color: green;">/* CIL Browser (https://github.com/MSDN-WhiteKnight/CilBrowser)
 * Copyright (c) 2022,  MSDN.WhiteKnight 
 * License: BSD 3-Clause */
</span><span style="color: blue;">using </span>System;
<span style="color: blue;">using </span>System.Collections.Generic;
<span style="color: blue;">using </span>System.Diagnostics;
<span style="color: blue;">using </span>System.IO;
<span style="color: blue;">using </span>System.Globalization;
<span style="color: blue;">using </span>System.Linq;
<span style="color: blue;">using </span>System.Net;
<span style="color: blue;">using </span>System.Reflection;
<span style="color: blue;">using </span>System.Text;
<span style="color: blue;">using </span>CilBrowser.Core.SyntaxModel;
<span style="color: blue;">using </span>CilTools.BytecodeAnalysis;
<span style="color: blue;">using </span>CilTools.Reflection;
<span style="color: blue;">using </span>CilTools.SourceCode.Common;
<span style="color: blue;">using </span>CilTools.Syntax;

<span style="color: blue;">namespace </span>CilBrowser.Core
{
    <span style="color: green;">/// &lt;summary&gt;
    </span><span style="color: green;">/// Visualizes CIL or source text as HTML in the context of the specified assembly
    </span><span style="color: green;">/// &lt;/summary&gt;
    </span><span style="color: blue;">public </span><span style="color: blue;">class </span>HtmlGenerator
    {
        Assembly _ass; <span style="color: green;">//could be null when unknown
        </span><span style="color: blue;">string </span>_nsFilter; <span style="color: green;">//could be empty string when there&#39;s no namespace filter
        </span><span style="color: blue;">string </span>_customFooter; <span style="color: green;">//could be empty string when there&#39;s no custom footer

        </span><span style="color: blue;">const </span><span style="color: blue;">string </span>Footer = <span style="color: red;">&quot;Generated by &lt;a href=\&quot;https://github.com/MSDN-WhiteKnight/CilBrowser\&quot;&gt;CIL Browser&lt;/a&gt;&quot;</span>;
        <span style="color: blue;">const </span><span style="color: blue;">string </span>GlobalStyles = <span style="color: red;">&quot;.memberid { color: rgb(43, 145, 175); text-decoration: none; }&quot;</span>;
        
        <span style="color: blue;">public </span>HtmlGenerator()
        {
            <span style="color: blue;">this</span>._ass = <span style="color: blue;">null</span>;
            <span style="color: blue;">this</span>._nsFilter = <span style="color: blue;">string</span>.Empty;
            <span style="color: blue;">this</span>._customFooter = <span style="color: blue;">string</span>.Empty;
        }

        <span style="color: blue;">public </span>HtmlGenerator(Assembly ass)
        {
            <span style="color: blue;">this</span>._ass = ass;
            <span style="color: blue;">this</span>._nsFilter = <span style="color: blue;">string</span>.Empty;
            <span style="color: blue;">this</span>._customFooter = <span style="color: blue;">string</span>.Empty;
        }

        <span style="color: blue;">public </span>HtmlGenerator(Assembly ass, <span style="color: blue;">string </span>ns, <span style="color: blue;">string </span>footer)
        {
            <span style="color: blue;">if </span>(ns == <span style="color: blue;">null</span>) ns = <span style="color: blue;">string</span>.Empty;
            <span style="color: blue;">if </span>(footer == <span style="color: blue;">null</span>) footer = <span style="color: blue;">string</span>.Empty;

            <span style="color: blue;">this</span>._ass = ass;
            <span style="color: blue;">this</span>._nsFilter = ns;
            <span style="color: blue;">this</span>._customFooter = footer;
        }

        <span style="color: blue;">public </span><span style="color: blue;">string </span>CustomFooter
        {
            get { <span style="color: blue;">return </span><span style="color: blue;">this</span>._customFooter; }
            set { <span style="color: blue;">this</span>._customFooter = value; }
        }
        
        <span style="color: blue;">static </span><span style="color: blue;">bool </span>IsMethodInAssembly(MethodBase mb, Assembly ass)
        {
            <span style="color: blue;">if </span>(mb == <span style="color: blue;">null </span>|| ass == <span style="color: blue;">null</span>) <span style="color: blue;">return </span><span style="color: blue;">false</span>;

            Type tDecl = mb.DeclaringType;

            <span style="color: blue;">return </span>Utils.IsTypeInAssembly(tDecl, ass);
        }

        <span style="color: blue;">static </span><span style="color: blue;">bool </span>IsNameToken(SyntaxNode node)
        {
            SourceToken tok = node <span style="color: blue;">as </span>SourceToken;

            <span style="color: blue;">if </span>(tok == <span style="color: blue;">null</span>) <span style="color: blue;">return </span><span style="color: blue;">false</span>;
            <span style="color: blue;">else </span><span style="color: blue;">return </span>tok.Kind == TokenKind.Name;
        }

        <span style="color: blue;">void </span>VisualizeNode(SyntaxNode node, HtmlBuilder target)
        {
            SyntaxNode[] children = node.GetChildNodes();
            HtmlAttribute[] attrs;

            <span style="color: blue;">if </span>(children.Length &gt; 0)
            {
                <span style="color: blue;">if </span>(node <span style="color: blue;">is </span>SyntaxElement)
                {
                    SyntaxElement elem = (SyntaxElement)node;

                    <span style="color: blue;">if </span>(elem.Kind == SyntaxKind.TagStart || elem.Kind == SyntaxKind.TagEnd)
                    {
                        SyntaxNode[] tokens = elem.GetChildNodes();
                        <span style="color: blue;">int </span>nameIndex;

                        <span style="color: blue;">if </span>(elem.Kind == SyntaxKind.TagStart) nameIndex = 1;
                        <span style="color: blue;">else </span>nameIndex = 2;

                        <span style="color: blue;">for </span>(<span style="color: blue;">int </span>i = 0; i &lt; tokens.Length; i++)
                        {
                            <span style="color: blue;">if </span>(i == nameIndex &amp;&amp; IsNameToken(tokens[i]))
                            {
                                <span style="color: green;">//highlighted tag name
                                </span>target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, tokens[i].ToString(),
                                    HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: blue;&quot;</span>));
                            }
                            <span style="color: blue;">else
                            </span>{
                                <span style="color: green;">//rest of the content
                                </span>VisualizeNode(tokens[i], target);
                            }
                        }
                    }
                    <span style="color: blue;">else
                    </span>{
                        <span style="color: blue;">foreach </span>(SyntaxNode child <span style="color: blue;">in </span>children) VisualizeNode(child, target);
                    }
                }
                <span style="color: blue;">else
                </span>{
                    <span style="color: green;">//other syntax nodes
                    </span><span style="color: blue;">foreach </span>(SyntaxNode child <span style="color: blue;">in </span>children) VisualizeNode(child, target);
                }
            }
            <span style="color: blue;">else </span><span style="color: blue;">if </span>(node <span style="color: blue;">is </span>KeywordSyntax)
            {
                KeywordSyntax ks = (KeywordSyntax)node;

                <span style="color: blue;">if </span>(ks.Kind == KeywordKind.DirectiveName)
                {
                    attrs = <span style="color: blue;">new </span>HtmlAttribute[1];
                    attrs[0] = <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: magenta;&quot;</span>);
                }
                <span style="color: blue;">else </span><span style="color: blue;">if </span>(ks.Kind == KeywordKind.Other)
                {
                    attrs = <span style="color: blue;">new </span>HtmlAttribute[1];
                    attrs[0] = <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: blue;&quot;</span>);
                }
                <span style="color: blue;">else </span>attrs = <span style="color: blue;">new </span>HtmlAttribute[0];

                target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), attrs);
            }
            <span style="color: blue;">else </span><span style="color: blue;">if </span>(node <span style="color: blue;">is </span>IdentifierSyntax)
            {
                IdentifierSyntax ids = (IdentifierSyntax)node;
                <span style="color: blue;">string </span>tagName;
                List&lt;HtmlAttribute&gt; attrList = <span style="color: blue;">new </span>List&lt;HtmlAttribute&gt;(5);

                <span style="color: blue;">if </span>(ids.IsMemberName)
                {
                    <span style="color: blue;">if </span>(ids.TargetMember <span style="color: blue;">is </span>Type)
                    {
                        Type targetType = (Type)ids.TargetMember;

                        <span style="color: blue;">if </span>(Utils.IsTypeInAssembly(targetType, <span style="color: blue;">this</span>._ass) &amp;&amp;
                            Utils.IsMatchingNamespaceFilter(targetType, <span style="color: blue;">this</span>._nsFilter))
                        {
                            <span style="color: green;">//hyperlink for types in the same assembly
                            </span>tagName = <span style="color: red;">&quot;a&quot;</span>;
                            attrList.Add(<span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;href&quot;</span>, GenerateTypeFileName(targetType)));
                        }
                        <span style="color: blue;">else
                        </span>{
                            <span style="color: green;">//plaintext name for other types
                            </span>tagName = <span style="color: red;">&quot;span&quot;</span>;
                        }
                    }
                    <span style="color: blue;">else </span><span style="color: blue;">if </span>(ids.TargetMember <span style="color: blue;">is </span>MethodBase)
                    {
                        MethodBase mb = (MethodBase)ids.TargetMember;

                        <span style="color: blue;">if </span>(node.Parent <span style="color: blue;">is </span>DirectiveSyntax &amp;&amp;
                            Utils.StrEquals(((DirectiveSyntax)node.Parent).Name, <span style="color: red;">&quot;method&quot;</span>))
                        {
                            <span style="color: green;">//anchor when in method signature
                            </span>tagName = <span style="color: red;">&quot;a&quot;</span>;
                            attrList.Add(<span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;name&quot;</span>, GenerateMethodAnchor(mb)));
                            attrList.Add(<span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;href&quot;</span>, GenerateMethodURL(mb)));
                        }
                        <span style="color: blue;">else </span><span style="color: blue;">if </span>(IsMethodInAssembly(mb, <span style="color: blue;">this</span>._ass) &amp;&amp;
                            Utils.IsMatchingNamespaceFilter(mb.DeclaringType, <span style="color: blue;">this</span>._nsFilter))
                        {
                            <span style="color: green;">//hyperlink for methods in the same assembly
                            </span>tagName = <span style="color: red;">&quot;a&quot;</span>;
                            attrList.Add(<span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;href&quot;</span>, GenerateMethodURL(mb)));
                        }
                        <span style="color: blue;">else
                        </span>{
                            <span style="color: green;">//plaintext name for other methods
                            </span>tagName = <span style="color: red;">&quot;span&quot;</span>;
                        }
                    }
                    <span style="color: blue;">else </span>tagName = <span style="color: red;">&quot;span&quot;</span>;

                    attrList.Add(<span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;class&quot;</span>, <span style="color: red;">&quot;memberid&quot;</span>));
                }
                <span style="color: blue;">else </span>tagName = <span style="color: red;">&quot;span&quot;</span>;
                
                target.WriteTag(tagName, node.ToString(), attrList.ToArray());
            }
            <span style="color: blue;">else </span><span style="color: blue;">if </span>(node <span style="color: blue;">is </span>LiteralSyntax)
            {
                LiteralSyntax ls = (LiteralSyntax)node;

                <span style="color: blue;">if </span>(ls.Value <span style="color: blue;">is </span><span style="color: blue;">string</span>)
                {
                    attrs = <span style="color: blue;">new </span>HtmlAttribute[1];
                    attrs[0] = <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: red;&quot;</span>);
                }
                <span style="color: blue;">else </span>attrs = <span style="color: blue;">new </span>HtmlAttribute[0];

                target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), attrs);
            }
            <span style="color: blue;">else </span><span style="color: blue;">if </span>(node <span style="color: blue;">is </span>CommentSyntax)
            {
                attrs = <span style="color: blue;">new </span>HtmlAttribute[1];
                attrs[0] = <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: green;&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), attrs);
            }
            <span style="color: blue;">else </span><span style="color: blue;">if </span>(node <span style="color: blue;">is </span>SourceToken)
            {
                SourceToken token = (SourceToken)node;
                
                <span style="color: blue;">switch </span>(token.Kind)
                {
                    <span style="color: blue;">case </span>TokenKind.Keyword:
                        target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: blue;&quot;</span>));
                        <span style="color: blue;">break</span>;
                    <span style="color: blue;">case </span>TokenKind.DoubleQuotLiteral:
                        target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: red;&quot;</span>));
                        <span style="color: blue;">break</span>;
                    <span style="color: blue;">case </span>TokenKind.SingleQuotLiteral:
                        target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: red;&quot;</span>));
                        <span style="color: blue;">break</span>;
                    <span style="color: blue;">case </span>TokenKind.SpecialTextLiteral:
                        target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: red;&quot;</span>));
                        <span style="color: blue;">break</span>;
                    <span style="color: blue;">case </span>TokenKind.Comment:
                        target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: green;&quot;</span>));
                        <span style="color: blue;">break</span>;
                    <span style="color: blue;">case </span>TokenKind.MultilineComment:
                        target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: green;&quot;</span>));
                        <span style="color: blue;">break</span>;
                    <span style="color: blue;">default</span>:
                        target.WriteEscaped(node.ToString());
                        <span style="color: blue;">break</span>;
                }
            }
            <span style="color: blue;">else
            </span>{
                target.WriteEscaped(node.ToString());
            }
        }

        <span style="color: blue;">void </span>WriteHeaderHTML(HtmlBuilder target)
        {
            target.StartParagraph();
            target.WriteEscaped(<span style="color: red;">&quot;.NET CIL Browser&quot;</span>);
            target.WriteRaw(<span style="color: red;">&quot;&amp;nbsp;-&amp;nbsp;&quot;</span>);

            <span style="color: blue;">if </span>(<span style="color: blue;">this</span>._ass != <span style="color: blue;">null</span>)
            {
                target.WriteHyperlink(<span style="color: red;">&quot;index.html&quot;</span>, <span style="color: blue;">this</span>._ass.GetName().Name);
            }
            <span style="color: blue;">else
            </span>{
                target.WriteHyperlink(<span style="color: red;">&quot;index.html&quot;</span>, <span style="color: red;">&quot;Back to table of contents&quot;</span>);
            }

            target.EndParagraph();
            target.WriteRaw(Environment.NewLine);
        }

        <span style="color: blue;">void </span>WriteLayoutStart(HtmlBuilder target, <span style="color: blue;">string </span>title, <span style="color: blue;">string </span>navigation)
        {
            target.StartDocument(title, GlobalStyles);
            <span style="color: blue;">this</span>.WriteHeaderHTML(target);
            target.WriteTag(<span style="color: red;">&quot;h2&quot;</span>, title);

            target.WriteTagStart(<span style="color: red;">&quot;table&quot;</span>, <span style="color: blue;">new </span>HtmlAttribute[] {
                <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;width&quot;</span>, <span style="color: red;">&quot;100%&quot;</span>), <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;cellpadding&quot;</span>, <span style="color: red;">&quot;5&quot;</span>),
                <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;cellspacing&quot;</span>, <span style="color: red;">&quot;5&quot;</span>)
            });

            target.WriteTagStart(<span style="color: red;">&quot;tr&quot;</span>);

            <span style="color: blue;">if </span>(!<span style="color: blue;">string</span>.IsNullOrEmpty(navigation))
            {
                target.WriteTagStart(<span style="color: red;">&quot;td&quot;</span>, <span style="color: blue;">new </span>HtmlAttribute[] {
                    <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;width&quot;</span>, <span style="color: red;">&quot;200&quot;</span>), <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;valign&quot;</span>, <span style="color: red;">&quot;top&quot;</span>),
                    <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;border: thin solid;&quot;</span>),
                });

                target.WriteRaw(navigation);
                target.WriteTagEnd(<span style="color: red;">&quot;td&quot;</span>);
                target.WriteRaw(Environment.NewLine);
            }

            target.WriteTagStart(<span style="color: red;">&quot;td&quot;</span>, HtmlBuilder.OneAttribute(<span style="color: red;">&quot;valign&quot;</span>, <span style="color: red;">&quot;top&quot;</span>));
        }

        <span style="color: blue;">void </span>WriteLayoutEnd(HtmlBuilder target)
        {
            target.WriteTagEnd(<span style="color: red;">&quot;td&quot;</span>);
            target.WriteTagEnd(<span style="color: red;">&quot;tr&quot;</span>);
            target.WriteTagEnd(<span style="color: red;">&quot;table&quot;</span>);

            target.StartParagraph();
            target.WriteHyperlink(<span style="color: red;">&quot;index.html&quot;</span>, <span style="color: red;">&quot;Back to table of contents&quot;</span>);
            target.EndParagraph();

            WriteFooter(target);
            target.EndDocument();
        }
        
        <span style="color: blue;">public </span><span style="color: blue;">void </span>VisualizeSyntaxNodes(IEnumerable&lt;SyntaxNode&gt; nodes, HtmlBuilder target)
        {
            target.WriteTagStart(<span style="color: red;">&quot;pre&quot;</span>, HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;white-space: pre-wrap;&quot;</span>));
            target.WriteTagStart(<span style="color: red;">&quot;code&quot;</span>);

            <span style="color: green;">//content
            </span><span style="color: blue;">foreach </span>(SyntaxNode node <span style="color: blue;">in </span>nodes) <span style="color: blue;">this</span>.VisualizeNode(node, target);

            target.WriteTagEnd(<span style="color: red;">&quot;code&quot;</span>);
            target.WriteTagEnd(<span style="color: red;">&quot;pre&quot;</span>);
        }

        <span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">string </span>VisualizeMethod(MethodBase mb)
        {
            CilGraph gr = CilGraph.Create(mb);
            SyntaxNode[] nodes = <span style="color: blue;">new </span>SyntaxNode[] { gr.ToSyntaxTree() };
            HtmlGenerator generator = <span style="color: blue;">new </span>HtmlGenerator();
            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(5000);
            HtmlBuilder builder = <span style="color: blue;">new </span>HtmlBuilder(sb);

            generator.WriteLayoutStart(builder, <span style="color: red;">&quot;Method: &quot; </span>+ mb.Name, <span style="color: blue;">string</span>.Empty);
            generator.VisualizeSyntaxNodes(nodes, builder);
            generator.WriteLayoutEnd(builder);

            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: blue;">static </span><span style="color: blue;">string </span>VisualizeNavigationPanel(Type t, Dictionary&lt;<span style="color: blue;">string</span>, List&lt;Type&gt;&gt; typeMap)
        {
            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(1000);
            HtmlBuilder html = <span style="color: blue;">new </span>HtmlBuilder(sb);            
            <span style="color: blue;">string </span>ns = t.Namespace;
            List&lt;Type&gt; types;

            <span style="color: blue;">if </span>(ns == <span style="color: blue;">null</span>) ns = <span style="color: blue;">string</span>.Empty;

            <span style="color: blue;">if </span>(typeMap.ContainsKey(ns)) types = typeMap[ns];
            <span style="color: blue;">else </span>types = <span style="color: blue;">new </span>List&lt;Type&gt;();

            <span style="color: blue;">if </span>(ns.Length &gt; 0)
            {
                html.WriteParagraph(<span style="color: red;">&quot;Types in &quot; </span>+ ns + <span style="color: red;">&quot; namespace:&quot;</span>);
            }
            <span style="color: blue;">else
            </span>{
                html.WriteParagraph(<span style="color: red;">&quot;Types without namespace:&quot;</span>);
            }

            <span style="color: green;">//list of types
            </span><span style="color: blue;">for </span>(<span style="color: blue;">int </span>i = 0; i &lt; types.Count; i++)
            {
                html.StartParagraph();

                <span style="color: blue;">if </span>(Utils.StrEquals(types[i].FullName, t.FullName))
                {
                    html.WriteTag(<span style="color: red;">&quot;b&quot;</span>, types[i].Name);
                }
                <span style="color: blue;">else
                </span>{
                    html.WriteHyperlink(GenerateTypeFileName(types[i]), types[i].Name);
                }

                html.EndParagraph();
            }

            <span style="color: blue;">return </span>sb.ToString();
        }
        
        <span style="color: blue;">public </span><span style="color: blue;">string </span>VisualizeType(Type t, Dictionary&lt;<span style="color: blue;">string</span>, List&lt;Type&gt;&gt; typeMap)
        {
            SyntaxNode[] nodes = SyntaxNode.GetTypeDefSyntax(t, <span style="color: blue;">true</span>, <span style="color: blue;">new </span>DisassemblerParams()).ToArray();

            <span style="color: blue;">if </span>(nodes.Length == 0) <span style="color: blue;">return </span><span style="color: blue;">string</span>.Empty;

            <span style="color: blue;">if </span>(nodes.Length == 1)
            {
                <span style="color: blue;">if </span>(<span style="color: blue;">string</span>.IsNullOrWhiteSpace(nodes[0].ToString())) <span style="color: blue;">return </span><span style="color: blue;">string</span>.Empty;
            }

            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(5000);
            HtmlBuilder html = <span style="color: blue;">new </span>HtmlBuilder(sb);

            <span style="color: blue;">string </span>navigation = VisualizeNavigationPanel(t, typeMap);
            <span style="color: blue;">this</span>.WriteLayoutStart(html, <span style="color: red;">&quot;Type: &quot; </span>+ t.FullName, navigation);
            <span style="color: blue;">this</span>.VisualizeSyntaxNodes(nodes, html);
            WriteLayoutEnd(html);

            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: blue;">public </span><span style="color: blue;">string </span>VisualizeAssemblyManifest(Assembly ass)
        {
            IEnumerable&lt;SyntaxNode&gt; nodes = Disassembler.GetAssemblyManifestSyntaxNodes(ass);
            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(5000);
            HtmlBuilder html = <span style="color: blue;">new </span>HtmlBuilder(sb);

            <span style="color: blue;">this</span>.WriteLayoutStart(html, <span style="color: red;">&quot;Assembly: &quot; </span>+ ass.GetName().Name, <span style="color: blue;">string</span>.Empty);
            <span style="color: blue;">this</span>.VisualizeSyntaxNodes(nodes, html);
            WriteLayoutEnd(html);

            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: blue;">void </span>VisualizeSourceTextImpl(<span style="color: blue;">string </span>content, <span style="color: blue;">string </span>ext, HtmlBuilder html)
        {
            <span style="color: green;">//convert source text into tokens
            </span>SyntaxNode[] nodes = SourceParser.Parse(content, ext);

            <span style="color: green;">//convert tokens to HTML
            </span><span style="color: blue;">this</span>.VisualizeSyntaxNodes(nodes, html);
        }

        <span style="color: blue;">public </span><span style="color: blue;">string </span>VisualizeSourceFile(<span style="color: blue;">string </span>content, <span style="color: blue;">string </span>filename, <span style="color: blue;">string </span>navigation, <span style="color: blue;">string </span>sourceControlUrl)
        {
            <span style="color: blue;">string </span>ext = Path.GetExtension(filename);
            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(5000);
            HtmlBuilder html = <span style="color: blue;">new </span>HtmlBuilder(sb);
            
            <span style="color: blue;">this</span>.WriteLayoutStart(html, <span style="color: red;">&quot;Source file: &quot; </span>+ filename, navigation);
            <span style="color: blue;">this</span>.VisualizeSourceTextImpl(content, ext, html);

            <span style="color: blue;">if </span>(!<span style="color: blue;">string</span>.IsNullOrEmpty(sourceControlUrl))
            {
                html.WriteHyperlink(Utils.UrlAppend(sourceControlUrl, filename), <span style="color: red;">&quot;View in source control&quot;</span>);
            }

            WriteLayoutEnd(html);

            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: green;">/// &lt;summary&gt;
        </span><span style="color: green;">/// Generates HTML markup with syntax highlighting for the specified source text and writes it into TextWriter. 
        </span><span style="color: green;">/// &lt;/summary&gt;
        </span><span style="color: green;">/// &lt;param name=&quot;sourceText&quot;&gt;Source text to render&lt;/param&gt;
        </span><span style="color: green;">/// &lt;param name=&quot;ext&quot;&gt;
        </span><span style="color: green;">/// Source file extension (with leading dot) that defines programming language. For example, &lt;c&gt;.cs&lt;/c&gt; for C#.
        </span><span style="color: green;">/// &lt;/param&gt;
        </span><span style="color: green;">/// &lt;param name=&quot;target&quot;&gt;Text writer where to output the resulting HTML&lt;/param&gt;
        </span><span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">void </span>RenderSourceText(<span style="color: blue;">string </span>sourceText, <span style="color: blue;">string </span>ext, TextWriter target)
        {
            <span style="color: blue;">if </span>(<span style="color: blue;">string</span>.IsNullOrEmpty(sourceText)) <span style="color: blue;">return</span>;

            <span style="color: blue;">if </span>(target == <span style="color: blue;">null</span>) <span style="color: blue;">throw </span><span style="color: blue;">new </span>ArgumentNullException(<span style="color: red;">&quot;target&quot;</span>);

            HtmlGenerator generator = <span style="color: blue;">new </span>HtmlGenerator();
            HtmlBuilder builder = <span style="color: blue;">new </span>HtmlBuilder(target);
            generator.VisualizeSourceTextImpl(sourceText, ext, builder);
            target.Flush();
        }

        <span style="color: green;">/// &lt;summary&gt;
        </span><span style="color: green;">/// Generates HTML markup with syntax highlighting for the specified source text.
        </span><span style="color: green;">/// &lt;/summary&gt;
        </span><span style="color: green;">/// &lt;param name=&quot;sourceText&quot;&gt;Source text to render&lt;/param&gt;
        </span><span style="color: green;">/// &lt;param name=&quot;ext&quot;&gt;
        </span><span style="color: green;">/// Source file extension (with leading dot) that defines programming language. For example, &lt;c&gt;.cs&lt;/c&gt; for C#.
        </span><span style="color: green;">/// &lt;/param&gt;
        </span><span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">string </span>RenderSourceText(<span style="color: blue;">string </span>sourceText, <span style="color: blue;">string </span>ext)
        {
            <span style="color: blue;">if </span>(<span style="color: blue;">string</span>.IsNullOrEmpty(sourceText)) <span style="color: blue;">return </span><span style="color: blue;">string</span>.Empty;

            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(sourceText.Length * 2);
            StringWriter wr = <span style="color: blue;">new </span>StringWriter(sb);
            HtmlGenerator generator = <span style="color: blue;">new </span>HtmlGenerator();
            HtmlBuilder builder = <span style="color: blue;">new </span>HtmlBuilder(wr);
            generator.VisualizeSourceTextImpl(sourceText, ext, builder);
            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: green;">/// &lt;summary&gt;
        </span><span style="color: green;">/// Writes CSS code containing syntax highlighting styles into the specified TextWriter. 
        </span><span style="color: green;">/// These styles are used in markup generated by &lt;see cref=&quot;RenderSourceText&quot;/&gt; method.
        </span><span style="color: green;">/// &lt;/summary&gt;
        </span><span style="color: green;">/// &lt;param name=&quot;target&quot;&gt;Text writer where to output the resulting CSS&lt;/param&gt;
        </span><span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">void </span>GetVisualStyles(TextWriter target)
        {
            <span style="color: blue;">if </span>(target == <span style="color: blue;">null</span>) <span style="color: blue;">throw </span><span style="color: blue;">new </span>ArgumentNullException(<span style="color: red;">&quot;target&quot;</span>);

            target.WriteLine(GlobalStyles);
            target.Flush();
        }

        <span style="color: green;">/// &lt;summary&gt;
        </span><span style="color: green;">/// Gets CSS code containing syntax highlighting styles. These styles are used in markup generated by 
        </span><span style="color: green;">/// &lt;see cref=&quot;RenderSourceText&quot;/&gt; method.
        </span><span style="color: green;">/// &lt;/summary&gt;
        </span><span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">string </span>GetVisualStyles()
        {
            <span style="color: blue;">return </span>GlobalStyles;
        }

        <span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">string </span>GenerateTypeFileName(Type t)
        {
            <span style="color: blue;">return </span>((<span style="color: blue;">uint</span>)t.MetadataToken).ToString(<span style="color: red;">&quot;X&quot;</span>, CultureInfo.InvariantCulture) + <span style="color: red;">&quot;.html&quot;</span>;
        }

        <span style="color: blue;">static </span><span style="color: blue;">string </span>GenerateMethodAnchor(MethodBase mb)
        {
            <span style="color: blue;">return </span><span style="color: red;">&quot;M&quot;</span>+((<span style="color: blue;">uint</span>)mb.MetadataToken).ToString(<span style="color: red;">&quot;X&quot;</span>, CultureInfo.InvariantCulture);
        }

        <span style="color: blue;">static </span><span style="color: blue;">string </span>GenerateMethodURL(MethodBase mb)
        {
            <span style="color: blue;">if </span>(mb.DeclaringType == <span style="color: blue;">null</span>) <span style="color: blue;">return </span><span style="color: blue;">string</span>.Empty;

            MethodBase targetMethod = mb;

            <span style="color: blue;">if </span>(mb.IsGenericMethod &amp;&amp; !mb.IsGenericMethodDefinition &amp;&amp; mb <span style="color: blue;">is </span>ICustomMethod)
            {
                <span style="color: green;">// if it&#39;s an instantiated generic method, we want to use method definition as link target
                </span>ICustomMethod cm = (ICustomMethod)mb;

                <span style="color: blue;">if </span>(cm.GetDefinition() != <span style="color: blue;">null</span>) targetMethod = cm.GetDefinition();
            }

            <span style="color: blue;">return </span>GenerateTypeFileName(mb.DeclaringType) + <span style="color: red;">&quot;#&quot; </span>+ GenerateMethodAnchor(targetMethod);
        }
        
        <span style="color: blue;">public </span><span style="color: blue;">void </span>WriteFooter(HtmlBuilder target)
        {
            target.WriteTag(<span style="color: red;">&quot;hr&quot;</span>, <span style="color: blue;">string</span>.Empty);

            <span style="color: blue;">if </span>(!<span style="color: blue;">string</span>.IsNullOrEmpty(<span style="color: blue;">this</span>._customFooter))
            {
                target.StartParagraph();
                target.WriteRaw(<span style="color: blue;">this</span>._customFooter);
                target.EndParagraph();
            }

            target.StartParagraph();
            target.WriteRaw(Footer);
            target.EndParagraph();
        }
        
        <span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">string </span>VisualizeException(Exception ex)
        {
            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(500);
            sb.Append(<span style="color: red;">&quot;&lt;pre&gt;&quot;</span>);
            sb.Append(WebUtility.HtmlEncode(ex.GetType().ToString()));
            sb.Append(<span style="color: red;">&quot;: &quot;</span>);
            sb.Append(WebUtility.HtmlEncode(ex.Message));
            sb.Append(<span style="color: red;">&quot;&lt;/pre&gt;&quot;</span>);
            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: blue;">static </span><span style="color: blue;">void </span>VisualizeVersionInfo(HtmlBuilder target, Assembly ass)
        {
            AssemblyName an = ass.GetName();
            target.WriteTagStart(<span style="color: red;">&quot;table&quot;</span>, HtmlBuilder.OneAttribute(<span style="color: red;">&quot;cellpadding&quot;</span>, <span style="color: red;">&quot;4&quot;</span>));

            <span style="color: blue;">if </span>(an.Version != <span style="color: blue;">null</span>)
            {
                target.WriteTagStart(<span style="color: red;">&quot;tr&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;td&quot;</span>, <span style="color: red;">&quot;Assembly version&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;td&quot;</span>, an.Version.ToString());
                target.WriteTagEnd(<span style="color: red;">&quot;tr&quot;</span>);
            }

            <span style="color: blue;">if </span>(<span style="color: blue;">string</span>.IsNullOrEmpty(ass.Location))
            {
                <span style="color: green;">//cannot display version info if location is unknown
                </span>target.WriteTagEnd(<span style="color: red;">&quot;table&quot;</span>);
                <span style="color: blue;">return</span>;
            }

            FileVersionInfo fvi;

            <span style="color: blue;">try
            </span>{
                fvi = FileVersionInfo.GetVersionInfo(ass.Location);
            }
            <span style="color: blue;">catch </span>(Exception ex)
            {
                target.WriteTagEnd(<span style="color: red;">&quot;table&quot;</span>);
                target.WriteParagraph(<span style="color: red;">&quot;Failed to get file version info!&quot;</span>);
                target.WriteRaw(VisualizeException(ex));                
                Console.WriteLine(ex.ToString());
                <span style="color: blue;">return</span>;
            }

            <span style="color: blue;">if </span>(fvi.FileVersion != <span style="color: blue;">null</span>)
            {
                target.WriteTagStart(<span style="color: red;">&quot;tr&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;td&quot;</span>, <span style="color: red;">&quot;File version&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;td&quot;</span>, fvi.FileVersion);
                target.WriteTagEnd(<span style="color: red;">&quot;tr&quot;</span>);
            }

            <span style="color: blue;">if </span>(fvi.ProductVersion != <span style="color: blue;">null</span>)
            {
                target.WriteTagStart(<span style="color: red;">&quot;tr&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;td&quot;</span>, <span style="color: red;">&quot;Product version&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;td&quot;</span>, fvi.ProductVersion);
                target.WriteTagEnd(<span style="color: red;">&quot;tr&quot;</span>);
            }

            <span style="color: blue;">if </span>(fvi.ProductName != <span style="color: blue;">null</span>)
            {
                target.WriteTagStart(<span style="color: red;">&quot;tr&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;td&quot;</span>, <span style="color: red;">&quot;Product name&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;td&quot;</span>, fvi.ProductName);
                target.WriteTagEnd(<span style="color: red;">&quot;tr&quot;</span>);
            }

            <span style="color: blue;">if </span>(fvi.CompanyName != <span style="color: blue;">null</span>)
            {
                target.WriteTagStart(<span style="color: red;">&quot;tr&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;td&quot;</span>, <span style="color: red;">&quot;Vendor&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;td&quot;</span>, fvi.CompanyName);
                target.WriteTagEnd(<span style="color: red;">&quot;tr&quot;</span>);
            }

            target.WriteTagEnd(<span style="color: red;">&quot;table&quot;</span>);
            
            <span style="color: blue;">if </span>(!<span style="color: blue;">string</span>.IsNullOrEmpty(fvi.LegalCopyright)) target.WriteParagraph(fvi.LegalCopyright);
        }

        <span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">void </span>WriteTocStart(HtmlBuilder toc, Assembly ass)
        {
            AssemblyName an = ass.GetName();
            toc.StartDocument(<span style="color: red;">&quot;.NET CIL Browser - &quot; </span>+ an.Name, GlobalStyles);
            toc.WriteParagraph(<span style="color: red;">&quot;.NET CIL Browser&quot;</span>);
            toc.WriteTag(<span style="color: red;">&quot;h1&quot;</span>, an.Name);
            VisualizeVersionInfo(toc, ass);
            toc.WriteRaw(Environment.NewLine);
            toc.StartParagraph();
            toc.WriteHyperlink(<span style="color: red;">&quot;assembly.html&quot;</span>, <span style="color: red;">&quot;(Assembly manifest)&quot;</span>);
            toc.EndParagraph();
            toc.WriteParagraph(<span style="color: red;">&quot;Types in assembly: &quot;</span>);
        }

        <span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">void </span>WriteTocStart(HtmlBuilder toc, <span style="color: blue;">string </span>dirName)
        {
            toc.StartDocument(<span style="color: red;">&quot;.NET CIL Browser - &quot; </span>+ dirName, GlobalStyles);
            toc.WriteParagraph(<span style="color: red;">&quot;.NET CIL Browser&quot;</span>);
            toc.WriteTag(<span style="color: red;">&quot;h1&quot;</span>, <span style="color: red;">&quot;Source directory: &quot; </span>+ dirName);
            toc.WriteRaw(Environment.NewLine);
        }
    }
}
</code></pre><a href="https://github.com/MSDN-WhiteKnight/CilBrowser/tree/main/CilBrowser.Core/HtmlGenerator.cs">View in source control</a></td></tr></table><p><a href="index.html">Back to table of contents</a></p><hr/><p>Generated by <a href="https://github.com/MSDN-WhiteKnight/CilBrowser">CIL Browser</a></p>
</body></html>