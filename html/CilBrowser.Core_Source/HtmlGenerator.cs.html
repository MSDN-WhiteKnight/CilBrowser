<html><head><title>Source file: HtmlGenerator.cs</title><style>.memberid { color: rgb(43, 145, 175); text-decoration: none; }</style></head>
<body><p>.NET CIL Browser&nbsp;-&nbsp;<a href="index.html">Back to table of contents</a></p>
<h2>Source file: HtmlGenerator.cs</h2><table width="100%" cellpadding="5" cellspacing="5"><tr><td width="200" valign="top" style="border: thin solid;"><p>Files in CilBrowser.Core directory:</p><p><a href="CilBrowser.Core.csproj.html">CilBrowser.Core.csproj</a></p><p><a href="HtmlAttribute.cs.html">HtmlAttribute.cs</a></p><p><a href="HtmlBuilder.cs.html">HtmlBuilder.cs</a></p><p><b>HtmlGenerator.cs</b></p><p><a href="IlasmClassifier.cs.html">IlasmClassifier.cs</a></p><p><a href="NullClassifier.cs.html">NullClassifier.cs</a></p><p><a href="Utils.cs.html">Utils.cs</a></p></td>
<td valign="top"><pre style="white-space: pre-wrap;"><code><span style="color: green;">/* CIL Browser (https://github.com/MSDN-WhiteKnight/CilBrowser)
 * Copyright (c) 2022,  MSDN.WhiteKnight 
 * License: BSD 3-Clause */
</span><span style="color: blue;">using </span>System;
<span style="color: blue;">using </span>System.Collections.Generic;
<span style="color: blue;">using </span>System.IO;
<span style="color: blue;">using </span>System.Globalization;
<span style="color: blue;">using </span>System.Linq;
<span style="color: blue;">using </span>System.Net;
<span style="color: blue;">using </span>System.Reflection;
<span style="color: blue;">using </span>System.Text;
<span style="color: blue;">using </span>CilTools.BytecodeAnalysis;
<span style="color: blue;">using </span>CilTools.Syntax;
<span style="color: blue;">using </span>CilView.Core.Syntax;
<span style="color: blue;">using </span>CilView.SourceCode;

<span style="color: blue;">namespace </span>CilBrowser.Core
{
    <span style="color: blue;">public </span><span style="color: blue;">class </span>HtmlGenerator
    {
        Assembly _ass; <span style="color: green;">//could be null when unknown

        </span><span style="color: blue;">const </span><span style="color: blue;">string </span>Footer = <span style="color: red;">&quot;Generated by &lt;a href=\&quot;https://github.com/MSDN-WhiteKnight/CilBrowser\&quot;&gt;CIL Browser&lt;/a&gt;&quot;</span>;
        <span style="color: blue;">const </span><span style="color: blue;">string </span>GlobalStyles = <span style="color: red;">&quot;.memberid { color: rgb(43, 145, 175); text-decoration: none; }&quot;</span>;

        <span style="color: blue;">static </span>HashSet&lt;<span style="color: blue;">string</span>&gt; s_srcExtensions = <span style="color: blue;">new </span>HashSet&lt;<span style="color: blue;">string</span>&gt;(<span style="color: blue;">new </span><span style="color: blue;">string</span>[] { 
            <span style="color: red;">&quot;.il&quot;</span>, <span style="color: red;">&quot;.cil&quot;</span>, <span style="color: red;">&quot;.cs&quot;</span>, <span style="color: red;">&quot;.vb&quot;</span>, <span style="color: red;">&quot;.c&quot;</span>, <span style="color: red;">&quot;.cpp&quot;</span>, <span style="color: red;">&quot;.h&quot;</span>, <span style="color: red;">&quot;.hpp&quot;</span>, <span style="color: red;">&quot;.js&quot;</span>, <span style="color: red;">&quot;.ts&quot;</span>, <span style="color: red;">&quot;.fs&quot;</span>, <span style="color: red;">&quot;.txt&quot;</span>, <span style="color: red;">&quot;.md&quot;</span>, <span style="color: red;">&quot;.htm&quot;</span>, <span style="color: red;">&quot;.html&quot;</span>,
            <span style="color: red;">&quot;.css&quot;</span>, <span style="color: red;">&quot;.xml&quot;</span>, <span style="color: red;">&quot;.csproj&quot;</span>, <span style="color: red;">&quot;.vbproj&quot;</span>, <span style="color: red;">&quot;.vcxproj&quot;</span>, <span style="color: red;">&quot;.proj&quot;</span>, <span style="color: red;">&quot;.rc&quot;</span>, <span style="color: red;">&quot;.cmd&quot;</span>, <span style="color: red;">&quot;.bat&quot;</span>, <span style="color: red;">&quot;.sh&quot;</span>, <span style="color: red;">&quot;.ps1&quot;</span>, <span style="color: red;">&quot;.xaml&quot;</span>, 
            <span style="color: red;">&quot;.config&quot;</span>, <span style="color: red;">&quot;.json&quot;</span>, <span style="color: red;">&quot;.yml&quot;</span>, <span style="color: red;">&quot;.sln&quot;</span>, <span style="color: red;">&quot;.props&quot;</span>, <span style="color: red;">&quot;.targets&quot;
        </span>});

        <span style="color: blue;">static </span>HashSet&lt;<span style="color: blue;">string</span>&gt; s_excludedDirs = <span style="color: blue;">new </span>HashSet&lt;<span style="color: blue;">string</span>&gt;(<span style="color: blue;">new </span><span style="color: blue;">string</span>[] {
            <span style="color: red;">&quot;.git&quot;</span>, <span style="color: red;">&quot;bin&quot;</span>, <span style="color: red;">&quot;obj&quot;</span>, <span style="color: red;">&quot;packages&quot;</span>, <span style="color: red;">&quot;.vs&quot;</span>, <span style="color: red;">&quot;TestResults&quot;</span>, <span style="color: red;">&quot;Debug&quot;</span>, <span style="color: red;">&quot;Release&quot;
        </span>});

        <span style="color: blue;">public </span>HtmlGenerator()
        {
            <span style="color: blue;">this</span>._ass = <span style="color: blue;">null</span>;
        }

        <span style="color: blue;">public </span>HtmlGenerator(Assembly ass)
        {
            <span style="color: blue;">this</span>._ass = ass;
        }

        <span style="color: blue;">static </span><span style="color: blue;">bool </span>IsTypeInAssembly(Type t, Assembly ass)
        {
            <span style="color: blue;">if </span>(t == <span style="color: blue;">null </span>|| ass == <span style="color: blue;">null</span>) <span style="color: blue;">return </span><span style="color: blue;">false</span>;

            Assembly typeAssembly = t.Assembly;

            <span style="color: blue;">if </span>(typeAssembly == <span style="color: blue;">null</span>) <span style="color: blue;">return </span><span style="color: blue;">false</span>;

            <span style="color: blue;">string </span>name1 = typeAssembly.GetName().Name;
            <span style="color: blue;">string </span>name2 = ass.GetName().Name;
            <span style="color: blue;">return </span><span style="color: blue;">string</span>.Equals(name1, name2, StringComparison.InvariantCultureIgnoreCase);
        }

        <span style="color: blue;">static </span><span style="color: blue;">bool </span>IsMethodInAssembly(MethodBase mb, Assembly ass)
        {
            <span style="color: blue;">if </span>(mb == <span style="color: blue;">null </span>|| ass == <span style="color: blue;">null</span>) <span style="color: blue;">return </span><span style="color: blue;">false</span>;

            Type tDecl = mb.DeclaringType;

            <span style="color: blue;">return </span>IsTypeInAssembly(tDecl, ass);
        }

        <span style="color: blue;">void </span>VisualizeNode(SyntaxNode node, HtmlBuilder target)
        {
            SyntaxNode[] children = node.GetChildNodes();
            HtmlAttribute[] attrs;

            <span style="color: blue;">if </span>(children.Length &gt; 0)
            {
                <span style="color: blue;">foreach </span>(SyntaxNode child <span style="color: blue;">in </span>children) VisualizeNode(child, target);
            }
            <span style="color: blue;">else </span><span style="color: blue;">if </span>(node <span style="color: blue;">is </span>KeywordSyntax)
            {
                KeywordSyntax ks = (KeywordSyntax)node;

                <span style="color: blue;">if </span>(ks.Kind == KeywordKind.DirectiveName)
                {
                    attrs = <span style="color: blue;">new </span>HtmlAttribute[1];
                    attrs[0] = <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: magenta;&quot;</span>);
                }
                <span style="color: blue;">else </span><span style="color: blue;">if </span>(ks.Kind == KeywordKind.Other)
                {
                    attrs = <span style="color: blue;">new </span>HtmlAttribute[1];
                    attrs[0] = <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: blue;&quot;</span>);
                }
                <span style="color: blue;">else </span>attrs = <span style="color: blue;">new </span>HtmlAttribute[0];

                target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), attrs);
            }
            <span style="color: blue;">else </span><span style="color: blue;">if </span>(node <span style="color: blue;">is </span>IdentifierSyntax)
            {
                IdentifierSyntax ids = (IdentifierSyntax)node;
                <span style="color: blue;">string </span>tagName;
                List&lt;HtmlAttribute&gt; attrList = <span style="color: blue;">new </span>List&lt;HtmlAttribute&gt;(5);

                <span style="color: blue;">if </span>(ids.IsMemberName)
                {
                    <span style="color: blue;">if </span>(ids.TargetMember <span style="color: blue;">is </span>Type)
                    {
                        Type targetType = (Type)ids.TargetMember;

                        <span style="color: blue;">if </span>(IsTypeInAssembly(targetType, <span style="color: blue;">this</span>._ass))
                        {
                            <span style="color: green;">//hyperlink for types in the same assembly
                            </span>tagName = <span style="color: red;">&quot;a&quot;</span>;
                            attrList.Add(<span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;href&quot;</span>, GenerateTypeFileName(targetType)));
                        }
                        <span style="color: blue;">else
                        </span>{
                            <span style="color: green;">//plaintext name for other types
                            </span>tagName = <span style="color: red;">&quot;span&quot;</span>;
                        }
                    }
                    <span style="color: blue;">else </span><span style="color: blue;">if </span>(ids.TargetMember <span style="color: blue;">is </span>MethodBase)
                    {
                        MethodBase mb = (MethodBase)ids.TargetMember;

                        <span style="color: blue;">if </span>(node.Parent <span style="color: blue;">is </span>DirectiveSyntax &amp;&amp;
                            Utils.StrEquals(((DirectiveSyntax)node.Parent).Name, <span style="color: red;">&quot;method&quot;</span>))
                        {
                            <span style="color: green;">//anchor when in method signature
                            </span>tagName = <span style="color: red;">&quot;a&quot;</span>;
                            attrList.Add(<span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;name&quot;</span>, GenerateMethodAnchor(mb)));
                            attrList.Add(<span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;href&quot;</span>, GenerateMethodURL(mb)));
                        }
                        <span style="color: blue;">else </span><span style="color: blue;">if </span>(IsMethodInAssembly(mb, <span style="color: blue;">this</span>._ass))
                        {
                            <span style="color: green;">//hyperlink for methods in the same assembly
                            </span>tagName = <span style="color: red;">&quot;a&quot;</span>;
                            attrList.Add(<span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;href&quot;</span>, GenerateMethodURL(mb)));
                        }
                        <span style="color: blue;">else
                        </span>{
                            <span style="color: green;">//plaintext name for other methods
                            </span>tagName = <span style="color: red;">&quot;span&quot;</span>;
                        }
                    }
                    <span style="color: blue;">else </span>tagName = <span style="color: red;">&quot;span&quot;</span>;

                    attrList.Add(<span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;class&quot;</span>, <span style="color: red;">&quot;memberid&quot;</span>));
                }
                <span style="color: blue;">else </span>tagName = <span style="color: red;">&quot;span&quot;</span>;
                
                target.WriteTag(tagName, node.ToString(), attrList.ToArray());
            }
            <span style="color: blue;">else </span><span style="color: blue;">if </span>(node <span style="color: blue;">is </span>LiteralSyntax)
            {
                LiteralSyntax ls = (LiteralSyntax)node;

                <span style="color: blue;">if </span>(ls.Value <span style="color: blue;">is </span><span style="color: blue;">string</span>)
                {
                    attrs = <span style="color: blue;">new </span>HtmlAttribute[1];
                    attrs[0] = <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: red;&quot;</span>);
                }
                <span style="color: blue;">else </span>attrs = <span style="color: blue;">new </span>HtmlAttribute[0];

                target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), attrs);
            }
            <span style="color: blue;">else </span><span style="color: blue;">if </span>(node <span style="color: blue;">is </span>CommentSyntax)
            {
                attrs = <span style="color: blue;">new </span>HtmlAttribute[1];
                attrs[0] = <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: green;&quot;</span>);
                target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), attrs);
            }
            <span style="color: blue;">else </span><span style="color: blue;">if </span>(node <span style="color: blue;">is </span>SourceToken)
            {
                SourceToken token = (SourceToken)node;
                
                <span style="color: blue;">switch </span>(token.Kind)
                {
                    <span style="color: blue;">case </span>TokenKind.Keyword:
                        target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: blue;&quot;</span>));
                        <span style="color: blue;">break</span>;
                    <span style="color: blue;">case </span>TokenKind.DoubleQuotLiteral:
                        target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: red;&quot;</span>));
                        <span style="color: blue;">break</span>;
                    <span style="color: blue;">case </span>TokenKind.SingleQuotLiteral:
                        target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: red;&quot;</span>));
                        <span style="color: blue;">break</span>;
                    <span style="color: blue;">case </span>TokenKind.Comment:
                        target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: green;&quot;</span>));
                        <span style="color: blue;">break</span>;
                    <span style="color: blue;">case </span>TokenKind.MultilineComment:
                        target.WriteTag(<span style="color: red;">&quot;span&quot;</span>, node.ToString(), HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;color: green;&quot;</span>));
                        <span style="color: blue;">break</span>;
                    <span style="color: blue;">default</span>:
                        target.WriteEscaped(node.ToString());
                        <span style="color: blue;">break</span>;
                }
            }
            <span style="color: blue;">else
            </span>{
                target.WriteEscaped(node.ToString());
            }
        }

        <span style="color: blue;">void </span>WriteHeaderHTML(HtmlBuilder target)
        {
            target.StartParagraph();
            target.WriteEscaped(<span style="color: red;">&quot;.NET CIL Browser&quot;</span>);
            target.WriteRaw(<span style="color: red;">&quot;&amp;nbsp;-&amp;nbsp;&quot;</span>);

            <span style="color: blue;">if </span>(<span style="color: blue;">this</span>._ass != <span style="color: blue;">null</span>)
            {
                target.WriteHyperlink(<span style="color: red;">&quot;index.html&quot;</span>, <span style="color: blue;">this</span>._ass.GetName().Name);
            }
            <span style="color: blue;">else
            </span>{
                target.WriteHyperlink(<span style="color: red;">&quot;index.html&quot;</span>, <span style="color: red;">&quot;Back to table of contents&quot;</span>);
            }

            target.EndParagraph();
            target.WriteRaw(Environment.NewLine);
        }

        <span style="color: blue;">void </span>WriteLayoutStart(HtmlBuilder target, <span style="color: blue;">string </span>title, <span style="color: blue;">string </span>navigation)
        {
            target.StartDocument(title, GlobalStyles);
            <span style="color: blue;">this</span>.WriteHeaderHTML(target);
            target.WriteTag(<span style="color: red;">&quot;h2&quot;</span>, title);

            target.WriteTagStart(<span style="color: red;">&quot;table&quot;</span>, <span style="color: blue;">new </span>HtmlAttribute[] {
                <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;width&quot;</span>, <span style="color: red;">&quot;100%&quot;</span>), <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;cellpadding&quot;</span>, <span style="color: red;">&quot;5&quot;</span>),
                <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;cellspacing&quot;</span>, <span style="color: red;">&quot;5&quot;</span>)
            });

            target.WriteTagStart(<span style="color: red;">&quot;tr&quot;</span>);

            <span style="color: blue;">if </span>(!<span style="color: blue;">string</span>.IsNullOrEmpty(navigation))
            {
                target.WriteTagStart(<span style="color: red;">&quot;td&quot;</span>, <span style="color: blue;">new </span>HtmlAttribute[] {
                    <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;width&quot;</span>, <span style="color: red;">&quot;200&quot;</span>), <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;valign&quot;</span>, <span style="color: red;">&quot;top&quot;</span>),
                    <span style="color: blue;">new </span>HtmlAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;border: thin solid;&quot;</span>),
                });

                target.WriteRaw(navigation);
                target.WriteTagEnd(<span style="color: red;">&quot;td&quot;</span>);
                target.WriteRaw(Environment.NewLine);
            }

            target.WriteTagStart(<span style="color: red;">&quot;td&quot;</span>, HtmlBuilder.OneAttribute(<span style="color: red;">&quot;valign&quot;</span>, <span style="color: red;">&quot;top&quot;</span>));
        }

        <span style="color: blue;">static </span><span style="color: blue;">void </span>WriteLayoutEnd(HtmlBuilder target)
        {
            target.WriteTagEnd(<span style="color: red;">&quot;td&quot;</span>);
            target.WriteTagEnd(<span style="color: red;">&quot;tr&quot;</span>);
            target.WriteTagEnd(<span style="color: red;">&quot;table&quot;</span>);

            target.StartParagraph();
            target.WriteHyperlink(<span style="color: red;">&quot;index.html&quot;</span>, <span style="color: red;">&quot;Back to table of contents&quot;</span>);
            target.EndParagraph();

            WriteFooter(target);
            target.EndDocument();
        }
        
        <span style="color: blue;">public </span><span style="color: blue;">void </span>VisualizeSyntaxNodes(IEnumerable&lt;SyntaxNode&gt; nodes, HtmlBuilder target)
        {
            target.WriteTagStart(<span style="color: red;">&quot;pre&quot;</span>, HtmlBuilder.OneAttribute(<span style="color: red;">&quot;style&quot;</span>, <span style="color: red;">&quot;white-space: pre-wrap;&quot;</span>));
            target.WriteTagStart(<span style="color: red;">&quot;code&quot;</span>);

            <span style="color: green;">//content
            </span><span style="color: blue;">foreach </span>(SyntaxNode node <span style="color: blue;">in </span>nodes) <span style="color: blue;">this</span>.VisualizeNode(node, target);

            target.WriteTagEnd(<span style="color: red;">&quot;code&quot;</span>);
            target.WriteTagEnd(<span style="color: red;">&quot;pre&quot;</span>);
        }

        <span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">string </span>VisualizeMethod(MethodBase mb)
        {
            CilGraph gr = CilGraph.Create(mb);
            SyntaxNode[] nodes = <span style="color: blue;">new </span>SyntaxNode[] { gr.ToSyntaxTree() };
            HtmlGenerator generator = <span style="color: blue;">new </span>HtmlGenerator();
            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(5000);
            HtmlBuilder builder = <span style="color: blue;">new </span>HtmlBuilder(sb);

            generator.WriteLayoutStart(builder, <span style="color: red;">&quot;Method: &quot; </span>+ mb.Name, <span style="color: blue;">string</span>.Empty);
            generator.VisualizeSyntaxNodes(nodes, builder);
            WriteLayoutEnd(builder);

            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: blue;">static </span><span style="color: blue;">string </span>VisualizeNavigationPanel(Type t, Dictionary&lt;<span style="color: blue;">string</span>, List&lt;Type&gt;&gt; typeMap)
        {
            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(1000);
            HtmlBuilder html = <span style="color: blue;">new </span>HtmlBuilder(sb);            
            <span style="color: blue;">string </span>ns = t.Namespace;
            List&lt;Type&gt; types;

            <span style="color: blue;">if </span>(ns == <span style="color: blue;">null</span>) ns = <span style="color: blue;">string</span>.Empty;

            <span style="color: blue;">if </span>(typeMap.ContainsKey(ns)) types = typeMap[ns];
            <span style="color: blue;">else </span>types = <span style="color: blue;">new </span>List&lt;Type&gt;();

            <span style="color: blue;">if </span>(ns.Length &gt; 0)
            {
                html.WriteParagraph(<span style="color: red;">&quot;Types in &quot; </span>+ ns + <span style="color: red;">&quot; namespace:&quot;</span>);
            }
            <span style="color: blue;">else
            </span>{
                html.WriteParagraph(<span style="color: red;">&quot;Types without namespace:&quot;</span>);
            }

            <span style="color: green;">//list of types
            </span><span style="color: blue;">for </span>(<span style="color: blue;">int </span>i = 0; i &lt; types.Count; i++)
            {
                html.StartParagraph();

                <span style="color: blue;">if </span>(Utils.StrEquals(types[i].FullName, t.FullName))
                {
                    html.WriteTag(<span style="color: red;">&quot;b&quot;</span>, types[i].Name);
                }
                <span style="color: blue;">else
                </span>{
                    html.WriteHyperlink(GenerateTypeFileName(types[i]), types[i].Name);
                }

                html.EndParagraph();
            }

            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: blue;">static </span><span style="color: blue;">string </span>VisualizeNavigationPanel(<span style="color: blue;">string </span>filename, <span style="color: blue;">string </span>dirName, <span style="color: blue;">string</span>[] dirFiles)
        {
            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(1000);
            HtmlBuilder html = <span style="color: blue;">new </span>HtmlBuilder(sb);
            html.WriteParagraph(<span style="color: red;">&quot;Files in &quot; </span>+ dirName + <span style="color: red;">&quot; directory:&quot;</span>);

            <span style="color: green;">//list of files
            </span><span style="color: blue;">for </span>(<span style="color: blue;">int </span>i = 0; i &lt; dirFiles.Length; i++)
            {
                <span style="color: blue;">if </span>(!IsSourceFile(dirFiles[i])) <span style="color: blue;">continue</span>;

                html.StartParagraph();
                <span style="color: blue;">string </span>currFileName = Path.GetFileName(dirFiles[i]);

                <span style="color: blue;">if </span>(Utils.StrEquals(currFileName, filename))
                {
                    html.WriteTag(<span style="color: red;">&quot;b&quot;</span>, filename);
                }
                <span style="color: blue;">else
                </span>{
                    html.WriteHyperlink(currFileName + <span style="color: red;">&quot;.html&quot;</span>, currFileName);
                }

                html.EndParagraph();
            }

            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: blue;">public </span><span style="color: blue;">string </span>VisualizeType(Type t, Dictionary&lt;<span style="color: blue;">string</span>, List&lt;Type&gt;&gt; typeMap)
        {
            SyntaxNode[] nodes = SyntaxNode.GetTypeDefSyntax(t, <span style="color: blue;">true</span>, <span style="color: blue;">new </span>DisassemblerParams()).ToArray();

            <span style="color: blue;">if </span>(nodes.Length == 0) <span style="color: blue;">return </span><span style="color: blue;">string</span>.Empty;

            <span style="color: blue;">if </span>(nodes.Length == 1)
            {
                <span style="color: blue;">if </span>(<span style="color: blue;">string</span>.IsNullOrWhiteSpace(nodes[0].ToString())) <span style="color: blue;">return </span><span style="color: blue;">string</span>.Empty;
            }

            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(5000);
            HtmlBuilder html = <span style="color: blue;">new </span>HtmlBuilder(sb);

            <span style="color: blue;">string </span>navigation = VisualizeNavigationPanel(t, typeMap);
            <span style="color: blue;">this</span>.WriteLayoutStart(html, <span style="color: red;">&quot;Type: &quot; </span>+ t.FullName, navigation);
            <span style="color: blue;">this</span>.VisualizeSyntaxNodes(nodes, html);
            WriteLayoutEnd(html);

            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: blue;">public </span><span style="color: blue;">string </span>VisualizeAssemblyManifest(Assembly ass)
        {
            IEnumerable&lt;SyntaxNode&gt; nodes = Disassembler.GetAssemblyManifestSyntaxNodes(ass);
            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(5000);
            HtmlBuilder html = <span style="color: blue;">new </span>HtmlBuilder(sb);

            <span style="color: blue;">this</span>.WriteLayoutStart(html, <span style="color: red;">&quot;Assembly: &quot; </span>+ ass.GetName().Name, <span style="color: blue;">string</span>.Empty);
            <span style="color: blue;">this</span>.VisualizeSyntaxNodes(nodes, html);
            WriteLayoutEnd(html);

            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: blue;">static </span>SyntaxNode[] GetTokens(<span style="color: blue;">string </span>content, <span style="color: blue;">string </span>ext)
        {
            ext = ext.ToLower();

            <span style="color: blue;">if </span>(Utils.StrEquals(ext, <span style="color: red;">&quot;.il&quot;</span>) || Utils.StrEquals(ext, <span style="color: red;">&quot;.cil&quot;</span>))
            {
                <span style="color: blue;">return </span>SyntaxReader.ReadAllNodes(content);
            }
            <span style="color: blue;">else </span><span style="color: blue;">if </span>(Utils.StrEquals(ext, <span style="color: red;">&quot;.txt&quot;</span>) || Utils.StrEquals(ext, <span style="color: red;">&quot;.md&quot;</span>))
            {
                <span style="color: green;">//disable syntax highlighting for plaintext files
                </span><span style="color: blue;">return </span>TokenParser.ParseTokens(content, TokenParser.GetDefinitions(ext),
                    NullClassifier.Value);
            }
            <span style="color: blue;">else
            </span>{
                <span style="color: blue;">return </span>TokenParser.ParseTokens(content, TokenParser.GetDefinitions(ext),
                    TokenClassifier.Create(ext));
            }
        }

        <span style="color: blue;">public </span><span style="color: blue;">string </span>VisualizeSourceFile(<span style="color: blue;">string </span>content, <span style="color: blue;">string </span>filename, <span style="color: blue;">string </span>navigation)
        {
            <span style="color: blue;">string </span>ext = Path.GetExtension(filename);
            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(5000);
            HtmlBuilder html = <span style="color: blue;">new </span>HtmlBuilder(sb);

            <span style="color: green;">//convert source text into tokens
            </span>SyntaxNode[] nodes = GetTokens(content, ext);

            <span style="color: green;">//convert tokens to HTML
            </span><span style="color: blue;">this</span>.WriteLayoutStart(html, <span style="color: red;">&quot;Source file: &quot; </span>+ filename, navigation);
            <span style="color: blue;">this</span>.VisualizeSyntaxNodes(nodes, html);
            WriteLayoutEnd(html);

            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: blue;">static </span><span style="color: blue;">string </span>GenerateTypeFileName(Type t)
        {
            <span style="color: blue;">return </span>((<span style="color: blue;">uint</span>)t.MetadataToken).ToString(<span style="color: red;">&quot;X&quot;</span>, CultureInfo.InvariantCulture) + <span style="color: red;">&quot;.html&quot;</span>;
        }

        <span style="color: blue;">static </span><span style="color: blue;">string </span>GenerateMethodAnchor(MethodBase mb)
        {
            <span style="color: blue;">return </span><span style="color: red;">&quot;M&quot;</span>+((<span style="color: blue;">uint</span>)mb.MetadataToken).ToString(<span style="color: red;">&quot;X&quot;</span>, CultureInfo.InvariantCulture);
        }

        <span style="color: blue;">static </span><span style="color: blue;">string </span>GenerateMethodURL(MethodBase mb)
        {
            <span style="color: blue;">if </span>(mb.DeclaringType == <span style="color: blue;">null</span>) <span style="color: blue;">return </span><span style="color: blue;">string</span>.Empty;

            <span style="color: blue;">return </span>GenerateTypeFileName(mb.DeclaringType) + <span style="color: red;">&quot;#&quot; </span>+ GenerateMethodAnchor(mb);
        }

        <span style="color: blue;">static </span><span style="color: blue;">int </span>CompareTypes(Type x, Type y)
        {
            <span style="color: blue;">string </span>s1 = x.FullName;
            <span style="color: blue;">string </span>s2 = y.FullName;
            <span style="color: blue;">return </span><span style="color: blue;">string</span>.Compare(s1, s2, StringComparison.OrdinalIgnoreCase);
        }

        <span style="color: blue;">static </span><span style="color: blue;">void </span>WriteFooter(HtmlBuilder target)
        {
            target.WriteTag(<span style="color: red;">&quot;hr&quot;</span>, <span style="color: blue;">string</span>.Empty);
            target.StartParagraph();
            target.WriteRaw(Footer);
            target.EndParagraph();
        }

        <span style="color: blue;">static </span>Dictionary&lt;<span style="color: blue;">string</span>, List&lt;Type&gt;&gt; GroupByNamespace(Type[] types)
        {
            Dictionary&lt;<span style="color: blue;">string</span>, List&lt;Type&gt;&gt; ret = <span style="color: blue;">new </span>Dictionary&lt;<span style="color: blue;">string</span>, List&lt;Type&gt;&gt;();

            <span style="color: blue;">for </span>(<span style="color: blue;">int </span>i = 0; i &lt; types.Length; i++)
            {
                <span style="color: blue;">string </span>ns = types[i].Namespace;

                <span style="color: blue;">if </span>(ns == <span style="color: blue;">null</span>) ns = <span style="color: blue;">string</span>.Empty;

                List&lt;Type&gt; list;

                <span style="color: blue;">if </span>(ret.ContainsKey(ns))
                {
                    list = ret[ns];
                }
                <span style="color: blue;">else
                </span>{
                    list = <span style="color: blue;">new </span>List&lt;Type&gt;();
                    ret[ns] = list;
                }

                list.Add(types[i]);
            }

            <span style="color: blue;">return </span>ret;
        }

        <span style="color: blue;">static </span><span style="color: blue;">string </span>VisualizeException(Exception ex)
        {
            StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(500);
            sb.Append(<span style="color: red;">&quot;&lt;pre&gt;&quot;</span>);
            sb.Append(WebUtility.HtmlEncode(ex.GetType().ToString()));
            sb.Append(<span style="color: red;">&quot;: &quot;</span>);
            sb.Append(WebUtility.HtmlEncode(ex.Message));
            sb.Append(<span style="color: red;">&quot;&lt;/pre&gt;&quot;</span>);
            <span style="color: blue;">return </span>sb.ToString();
        }

        <span style="color: green;">/// &lt;summary&gt;
        </span><span style="color: green;">/// Generates a static website that contains disassembled CIL for the specified assembly
        </span><span style="color: green;">/// &lt;/summary&gt;
        </span><span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">void </span>GenerateWebsite(Assembly ass, <span style="color: blue;">string </span>outputPath)
        {
            HtmlGenerator generator = <span style="color: blue;">new </span>HtmlGenerator(ass);
            Directory.CreateDirectory(outputPath);

            <span style="color: green;">//write assembly manifest
            </span><span style="color: blue;">string </span>html = generator.VisualizeAssemblyManifest(ass);
            File.WriteAllText(Path.Combine(outputPath, <span style="color: red;">&quot;assembly.html&quot;</span>), html);
            
            <span style="color: green;">//create Table of contents builder
            </span>StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(1000);
            HtmlBuilder toc = <span style="color: blue;">new </span>HtmlBuilder(sb);
            AssemblyName an = ass.GetName();
            Console.WriteLine(<span style="color: red;">&quot;Generating website for &quot; </span>+ an.Name);
            Console.WriteLine(<span style="color: red;">&quot;Output path: &quot; </span>+ outputPath);

            toc.StartDocument(<span style="color: red;">&quot;.NET CIL Browser - &quot; </span>+ an.Name, GlobalStyles);
            toc.WriteParagraph(<span style="color: red;">&quot;.NET CIL Browser&quot;</span>);
            toc.WriteTag(<span style="color: red;">&quot;h1&quot;</span>, an.Name);
            toc.WriteRaw(Environment.NewLine);
            toc.StartParagraph();
            toc.WriteHyperlink(<span style="color: red;">&quot;assembly.html&quot;</span>, <span style="color: red;">&quot;(Assembly manifest)&quot;</span>);
            toc.EndParagraph();
            toc.WriteParagraph(<span style="color: red;">&quot;Types in assembly: &quot;</span>);

            <span style="color: green;">//write types
            </span>Type[] types = ass.GetTypes();
            Dictionary&lt;<span style="color: blue;">string</span>, List&lt;Type&gt;&gt; typeMap = GroupByNamespace(types);
            <span style="color: blue;">string</span>[] namespaces = typeMap.Keys.ToArray();
            Array.Sort(namespaces);

            <span style="color: blue;">for </span>(<span style="color: blue;">int </span>i = 0; i &lt; namespaces.Length; i++)
            {
                <span style="color: blue;">string </span>nsText = namespaces[i];
                List&lt;Type&gt; nsTypes = typeMap[namespaces[i]];

                <span style="color: blue;">if </span>(nsTypes.Count == 0) <span style="color: blue;">continue</span>;

                <span style="color: blue;">if </span>(nsTypes.Count == 1)
                {
                    BindingFlags all = BindingFlags.Instance | BindingFlags.Static | BindingFlags.Public | 
                        BindingFlags.NonPublic;

                    <span style="color: blue;">if </span>(Utils.StrEquals(nsTypes[0].FullName, <span style="color: red;">&quot;&lt;Module&gt;&quot;</span>) &amp;&amp;
                        nsTypes[0].GetFields(all).Length == 0 &amp;&amp; nsTypes[0].GetMethods(all).Length == 0)
                    {
                        <span style="color: blue;">continue</span>; <span style="color: green;">//ignore namespace consisting only from empty &lt;Module&gt; type
                    </span>}
                }

                <span style="color: blue;">if </span>(<span style="color: blue;">string</span>.IsNullOrEmpty(nsText)) nsText = <span style="color: red;">&quot;(No namespace)&quot;</span>;
                <span style="color: blue;">else </span>nsText = nsText + <span style="color: red;">&quot; namespace&quot;</span>;

                toc.WriteTag(<span style="color: red;">&quot;h2&quot;</span>, nsText);
                nsTypes.Sort(CompareTypes);

                <span style="color: blue;">for </span>(<span style="color: blue;">int </span>j = 0; j &lt; nsTypes.Count; j++)
                {
                    <span style="color: green;">//file content
                    </span><span style="color: blue;">try
                    </span>{
                        html = generator.VisualizeType(nsTypes[j], typeMap);
                    }
                    <span style="color: blue;">catch </span>(NotSupportedException ex)
                    {
                        html = VisualizeException(ex);
                        Console.WriteLine(<span style="color: red;">&quot;Failed to generate HTML for &quot; </span>+ nsTypes[j].FullName);
                        Console.WriteLine(ex.ToString());
                    }

                    <span style="color: blue;">string </span>fname = GenerateTypeFileName(nsTypes[j]);

                    <span style="color: blue;">if </span>(!<span style="color: blue;">string</span>.IsNullOrWhiteSpace(html))
                    {
                        Console.WriteLine(nsTypes[j].FullName);

                        <span style="color: green;">//TOC entry
                        </span>toc.StartParagraph();
                        toc.WriteHyperlink(fname, nsTypes[j].FullName);
                        toc.EndParagraph();
                    }
                    <span style="color: blue;">else
                    </span>{
                        Console.WriteLine(nsTypes[j].FullName + <span style="color: red;">&quot; - empty&quot;</span>);
                    }
                    
                    File.WriteAllText(Path.Combine(outputPath, fname), html);        
                }
            }
            
            <span style="color: green;">//write TOC
            </span>WriteFooter(toc);
            toc.EndDocument();
            File.WriteAllText(Path.Combine(outputPath, <span style="color: red;">&quot;index.html&quot;</span>), sb.ToString());
        }

        <span style="color: blue;">static </span><span style="color: blue;">bool </span>IsSourceFile(<span style="color: blue;">string </span>name)
        {
            <span style="color: blue;">string </span>ext = Path.GetExtension(name).ToLower();

            <span style="color: blue;">return </span>ext == <span style="color: blue;">string</span>.Empty || s_srcExtensions.Contains(ext);
        }

        <span style="color: blue;">static </span><span style="color: blue;">bool </span>IsDirectoryExcluded(<span style="color: blue;">string </span>name)
        {
            <span style="color: blue;">return </span>s_excludedDirs.Contains(name);
        }

        <span style="color: blue;">public </span><span style="color: blue;">static </span><span style="color: blue;">void </span>GenerateWebsite(<span style="color: blue;">string </span>sourcesPath, <span style="color: blue;">string </span>outputPath, <span style="color: blue;">int </span>level)
        {
            <span style="color: blue;">if </span>(level &gt; 50)
            {
                Console.WriteLine(<span style="color: red;">&quot;Error: directory recursion is too deep!&quot;</span>);
                <span style="color: blue;">return</span>;
            }

            HtmlGenerator generator = <span style="color: blue;">new </span>HtmlGenerator();
            Directory.CreateDirectory(outputPath);
            
            <span style="color: green;">//create Table of contents builder
            </span>StringBuilder sb = <span style="color: blue;">new </span>StringBuilder(1000);
            HtmlBuilder toc = <span style="color: blue;">new </span>HtmlBuilder(sb);
            Console.WriteLine(<span style="color: red;">&quot;Generating website for source directory: &quot; </span>+ sourcesPath);
            Console.WriteLine(<span style="color: red;">&quot;Output path: &quot; </span>+ outputPath);

            <span style="color: blue;">string </span>dirName = Utils.GetDirectoryNameFromPath(sourcesPath);
            toc.StartDocument(<span style="color: red;">&quot;.NET CIL Browser - &quot; </span>+ dirName, GlobalStyles);
            toc.WriteParagraph(<span style="color: red;">&quot;.NET CIL Browser&quot;</span>);
            toc.WriteTag(<span style="color: red;">&quot;h1&quot;</span>, <span style="color: red;">&quot;Source directory: &quot; </span>+ dirName);
            toc.WriteRaw(Environment.NewLine);
            
            <span style="color: blue;">string</span>[] dirs = Directory.GetDirectories(sourcesPath);
            Array.Sort(dirs);

            <span style="color: blue;">if </span>(dirs.Length &gt; 0) toc.WriteTag(<span style="color: red;">&quot;h2&quot;</span>, <span style="color: red;">&quot;Subdirectories&quot;</span>);

            <span style="color: blue;">if </span>(level &gt; 0)
            {
                toc.StartParagraph();
                toc.WriteHyperlink(<span style="color: red;">&quot;../index.html&quot;</span>, <span style="color: red;">&quot;(go to parent directory)&quot;</span>);
                toc.EndParagraph();
            }

            <span style="color: blue;">for </span>(<span style="color: blue;">int </span>i = 0; i &lt; dirs.Length; i++)
            {
                <span style="color: blue;">string </span>name = Utils.GetDirectoryNameFromPath(dirs[i]);

                <span style="color: blue;">if </span>(IsDirectoryExcluded(name)) <span style="color: blue;">continue</span>;

                <span style="color: green;">//TOC entry
                </span>toc.StartParagraph();
                toc.WriteHyperlink(<span style="color: red;">&quot;./&quot; </span>+ name + <span style="color: red;">&quot;/index.html&quot;</span>, name);
                toc.EndParagraph();
            }
            
            <span style="color: green;">//write source files
            </span>toc.WriteRaw(Environment.NewLine);
            <span style="color: blue;">string</span>[] files = Directory.GetFiles(sourcesPath);
            Array.Sort(files);

            <span style="color: blue;">if </span>(files.Length &gt; 0) toc.WriteTag(<span style="color: red;">&quot;h2&quot;</span>, <span style="color: red;">&quot;Files&quot;</span>);

            <span style="color: blue;">for </span>(<span style="color: blue;">int </span>i = 0; i &lt; files.Length; i++)
            {
                <span style="color: blue;">if </span>(!IsSourceFile(files[i])) <span style="color: blue;">continue</span>;

                <span style="color: blue;">string </span>name = Path.GetFileName(files[i]);
                <span style="color: blue;">string </span>html;

                <span style="color: blue;">try
                </span>{
                    <span style="color: blue;">string </span>content = File.ReadAllText(files[i]);
                    <span style="color: blue;">string </span>navigation = VisualizeNavigationPanel(name, dirName, files);
                    html = generator.VisualizeSourceFile(content, name, navigation);
                }
                <span style="color: blue;">catch </span>(IOException ex)
                {
                    html = VisualizeException(ex);
                    Console.WriteLine(<span style="color: red;">&quot;Failed to generate HTML for &quot; </span>+ name);
                    Console.WriteLine(ex.ToString());
                }

                <span style="color: blue;">if </span>(!<span style="color: blue;">string</span>.IsNullOrWhiteSpace(html))
                {
                    Console.WriteLine(name);

                    <span style="color: green;">//file content
                    </span>File.WriteAllText(Path.Combine(outputPath, name + <span style="color: red;">&quot;.html&quot;</span>), html);

                    <span style="color: green;">//TOC entry
                    </span>toc.StartParagraph();
                    toc.WriteHyperlink(name + <span style="color: red;">&quot;.html&quot;</span>, name);
                    toc.EndParagraph();
                }
                <span style="color: blue;">else
                </span>{
                    Console.WriteLine(name + <span style="color: red;">&quot; - empty&quot;</span>);
                }
            }<span style="color: green;">//end for

            </span><span style="color: green;">//subdirectories
            </span><span style="color: blue;">for </span>(<span style="color: blue;">int </span>i = 0; i &lt; dirs.Length; i++)
            {
                <span style="color: blue;">string </span>name = Utils.GetDirectoryNameFromPath(dirs[i]);

                <span style="color: blue;">if </span>(IsDirectoryExcluded(name)) <span style="color: blue;">continue</span>;

                GenerateWebsite(dirs[i], Path.Combine(outputPath, name), level + 1);
            }

            <span style="color: green;">//write TOC
            </span>WriteFooter(toc);
            toc.EndDocument();
            File.WriteAllText(Path.Combine(outputPath, <span style="color: red;">&quot;index.html&quot;</span>), sb.ToString());
        }
    }
}
</code></pre></td></tr></table><p><a href="index.html">Back to table of contents</a></p><hr/><p>Generated by <a href="https://github.com/MSDN-WhiteKnight/CilBrowser">CIL Browser</a></p>
</body></html>